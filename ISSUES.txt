================================================================================
                    COMPREHENSIVE FLOW DOCUMENTATION & ISSUES
                    Dynamic QR Code Generator Platform
================================================================================

TABLE OF CONTENTS
-----------------
1. CLIENT SIGNUP AND SIGNIN FLOW
2. UPDATE PROFILE FLOW
3. CREATING QR CODE BY SAVING LINKS FLOW
4. ADMIN DASHBOARD FLOW
5. PAYMENT SYSTEM - CURRENT PROCESS
6. PAYMENT ISSUES - DETAILED PROBLEM ANALYSIS
7. WHAT NEEDS TO BE FIXED

================================================================================
1. CLIENT SIGNUP AND SIGNIN FLOW
================================================================================

A. SIGNUP FLOW
--------------
Route: POST /auth/register
File: routes/auth.js

STEP 1: User Registration Form
- User visits /login page
- Fills form with:
  * Name (minimum 2 characters)
  * Email (valid email format)
  * Password (minimum 6 characters)
  * Phone Number (required)

STEP 2: Backend Validation
- Validates all fields are present
- Validates email format using regex
- Validates password length (>= 6 characters)
- Validates name length (>= 2 characters)

STEP 3: Check Existing User
- Queries MongoDB: User.findOne({ email })
- If user exists → Returns error: "Email already registered"
- If user doesn't exist → Continues

STEP 4: Generate Unique Slug
- Extracts username from email: email.split('@')[0]
- Converts to lowercase and removes special characters
- Checks uniqueness: User.findOne({ uniqueSlug })
- If taken, appends counter: username1, username2, etc.
- Maximum 1000 attempts to prevent infinite loop

STEP 5: Create User Account
- Hashes password using bcrypt (10 rounds)
- Creates new User document in MongoDB:
  {
    email: email.toLowerCase().trim(),
    password: hashedPassword,
    name: name.trim(),
    phoneNumber: phoneNumber.trim(),
    uniqueSlug: uniqueSlug,
    lastLogin: new Date(),
    subscriptionActive: false,
    accountActivated: false,
    paymentCompleted: false
  }

STEP 6: Auto Login
- Uses Passport.js: req.login(user)
- Saves session to MongoDB: req.session.save()
- Returns JSON: { success: true, message: 'Registration successful' }

STEP 7: Frontend Response
- Shows success message
- Redirects to /complete-profile (if profile incomplete)
- OR redirects to /dashboard (if profile complete)

B. GOOGLE OAUTH SIGNUP/LOGIN FLOW
----------------------------------
Route: GET /auth/google → GET /auth/google/callback
File: routes/auth.js

STEP 1: User Clicks "Continue with Google"
- Browser redirects to /auth/google
- Passport authenticates with Google OAuth

STEP 2: Google Authentication
- User selects Google account
- Grants permissions (profile, email)
- Google redirects to /auth/google/callback?code=...

STEP 3: Backend Processing
- Exchanges code for access token
- Fetches user profile from Google
- Checks if user exists by googleId
  * If exists: Updates lastLogin, returns user
  * If doesn't exist: Checks email
    - If email exists: Links Google to existing user
    - If email doesn't exist: Creates new user

STEP 4: Generate Unique Slug
- Same process as email/password registration

STEP 5: Login and Redirect
- req.login(user)
- req.session.save()
- Checks if profile is complete:
  * If incomplete: Redirects to /complete-profile
  * If complete: Redirects to /dashboard

C. EMAIL/PASSWORD LOGIN FLOW
-----------------------------
Route: POST /auth/login
File: routes/auth.js

STEP 1: User Login Form
- User enters email and password
- Submits form

STEP 2: Backend Validation
- Validates email and password are present
- Finds user: User.findOne({ email }).select('+password')
- If user doesn't exist → Returns error: "Invalid email or password"

STEP 3: Password Verification
- Checks if user has password (might be Google-only account)
- If no password → Returns error: "Please login with Google or set a password"
- Compares password: bcrypt.compare(password, user.password)
- If doesn't match → Returns error: "Invalid email or password"

STEP 4: Login Success
- Updates lastLogin: user.lastLogin = new Date()
- Saves user
- req.login(user)
- req.session.save()
- Returns JSON: { success: true, message: 'Login successful' }

STEP 5: Frontend Response
- Shows success message
- Redirects to /complete-profile (if profile incomplete)
- OR redirects to /dashboard (if profile complete)

================================================================================
2. UPDATE PROFILE FLOW
================================================================================

Route: POST /dashboard/update-profile
File: routes/dashboard.js

STEP 1: User Fills Profile Form
- User is on /dashboard page
- Fills form with:
  * Business Name (optional)
  * Phone Number (optional)
  * Address (optional)
  * Business Logo (optional, max 100KB)
  * UPI ID (required for payment button)
  * Payee Name (optional, shown in payment app)
  * App ID (aid) (optional, removes ₹2000 limit)

STEP 2: Backend Processing
- Validates user is authenticated
- Finds user: User.findById(req.user._id)
- Updates fields:
  * businessName
  * phoneNumber
  * address
  * upiId (extracts from full URL if needed)
  * upiPayeeName
  * upiAid (extracts from UPI URL if pasted)

STEP 3: UPI ID Processing
- If UPI ID contains 'pa=' parameter:
  * Extracts UPI ID from 'pa=' parameter
  * Extracts 'aid' parameter if present
- If UPI ID contains 'aid=' parameter:
  * Extracts 'aid' parameter
  * Removes 'aid' from UPI ID

STEP 4: Logo Processing (if uploaded)
- Multer validates file (max 100KB, image only)
- Converts to base64 data URL
- Stores in user.logo field

STEP 5: Save User
- Saves updated user to MongoDB
- Returns JSON: { success: true, message: 'Profile updated successfully' }

STEP 6: Frontend Response
- Shows success message
- Updates UI with new profile data

================================================================================
3. CREATING QR CODE BY SAVING LINKS FLOW
================================================================================

A. ADDING LINKS
---------------
Route: POST /dashboard/add-link
File: routes/dashboard.js

STEP 1: User Adds Link
- User is on /dashboard page
- Clicks "Add Link" button
- Fills form:
  * Link Title (e.g., "Instagram", "Website")
  * Link URL (e.g., "https://instagram.com/username")
  * Category (optional, e.g., "instagram", "website", "payment")
  * Custom Icon (optional, max 100KB)

STEP 2: Backend Processing
- Validates user is authenticated
- Validates link title and URL are present
- Finds user: User.findById(req.user._id)
- Determines category:
  * If category provided: Uses that
  * If URL matches pattern (instagram.com, facebook.com, etc.): Auto-detects
  * Default: "website"

STEP 3: Icon Processing
- If custom icon uploaded:
  * Multer validates (max 100KB, image only)
  * Converts to base64 data URL
  * Stores in link.icon field
- If no custom icon:
  * Uses default icon from DEFAULT_CATEGORIES

STEP 4: Create Link
- Creates new Link document:
  {
    userId: user._id,
    title: title,
    url: url,
    category: category,
    icon: icon (base64 or default),
    order: nextOrderNumber,
    isActive: true
  }

STEP 5: Save and Return
- Saves link to MongoDB
- Returns JSON: { success: true, link: linkObject }

B. GENERATING QR CODE
---------------------
Route: GET /qr/generate
File: routes/qr.js

STEP 1: User Clicks "Generate QR Code"
- User is on /dashboard page
- Clicks "Generate QR Code" button
- Frontend sends GET request to /qr/generate

STEP 2: Backend Validation
- Validates user is authenticated
- Checks subscription status:
  * subscriptionActive must be true
  * subscriptionEndDate must be in future
  * If not active → Returns error: "Please subscribe (₹999/year)"
- Checks account activation:
  * accountActivated must be true
  * If not activated → Returns error: "Account pending admin approval"
- Checks active links:
  * Must have at least one active link
  * If no links → Returns error: "Please add at least one link"

STEP 3: Generate QR Code
- Builds page URL: BASE_URL + "/p/" + user.uniqueSlug
  Example: "https://dynamicqrgen.vercel.app/p/username"
- Generates QR code using 'qrcode' library:
  * Format: Base64 data URL
  * Size: 500x500px
  * Colors: Black on white

STEP 4: Add Business Name (if available)
- If canvas library available and businessName exists:
  * Loads QR code image
  * Creates canvas (500px QR + 80px text height)
  * Draws QR code
  * Draws business name below QR code
  * Uses Roboto font (if available) or fallback fonts
  * Word wraps if business name is long
- If canvas not available:
  * Uses QR code without text

STEP 5: Return QR Code
- Returns JSON:
  {
    success: true,
    qrUrl: "data:image/png;base64,...",
    pageUrl: "https://dynamicqrgen.vercel.app/p/username"
  }

STEP 6: Frontend Display
- Displays QR code image
- Shows download button
- User can download QR code

C. PUBLIC PAGE (What QR Code Points To)
----------------------------------------
Route: GET /p/:slug
File: routes/public.js

STEP 1: Customer Scans QR Code
- QR code contains: https://dynamicqrgen.vercel.app/p/username
- Customer's phone opens this URL

STEP 2: Backend Processing
- Finds user: User.findOne({ uniqueSlug: req.params.slug })
- If user not found → Returns 404: "Page not found"
- Checks subscription status (currently disabled for testing)
- Finds active links: Link.find({ userId: user._id, isActive: true })

STEP 3: Generate QR Code On-Demand
- Generates QR code for public page (same as client dashboard)
- Adds business name if available
- Uses same logic as /qr/generate route

STEP 4: Render Public Page
- Renders views/public-page.ejs with:
  * user object (with QR code)
  * links array
  * isPublic: true

STEP 5: Customer Sees Page
- Displays business logo
- Displays business name
- Displays QR code (with business name below)
- Displays action icons (links)
- Displays "Pay Now" button (if UPI ID configured)

================================================================================
4. ADMIN DASHBOARD FLOW
================================================================================

Route: GET /admin
File: routes/admin.js

A. ADMIN LOGIN
--------------
Route: GET /admin/login
File: routes/admin.js

STEP 1: Admin Access
- Admin visits /admin/login
- System auto-creates admin if doesn't exist:
  * Email: admin@qrconnect.com
  * Password: admin123 (hashed)
  * Name: Admin
  * Role: super_admin

STEP 2: Auto Login (Current Implementation)
- System automatically logs in admin
- No password required (for development)
- Creates session

STEP 3: Redirect to Dashboard
- Redirects to /admin

B. ADMIN DASHBOARD
------------------
Route: GET /admin
File: routes/admin.js

STEP 1: Load Dashboard
- Validates admin is authenticated
- Fetches statistics:
  * Total clients: User.countDocuments()
  * Active subscriptions: User.countDocuments({ subscriptionActive: true, subscriptionEndDate > now })
  * Total links: Link.countDocuments()
  * Total QR codes: User.countDocuments({ accountActivated: true })
  * Total revenue: Sum of subscriptionAmount for active subscriptions

STEP 2: Fetch Clients List
- Fetches all users with pagination
- Sorts by createdAt (newest first)
- Returns user data:
  * Name, Email, Business Name
  * Subscription status
  * Account activation status
  * Created date

STEP 3: Render Dashboard
- Renders views/admin-dashboard.ejs
- Displays statistics
- Displays clients list with pagination
- Each client has "View Details" button

C. CLIENT DETAILS
-----------------
Route: GET /admin/client/:id
File: routes/admin.js

STEP 1: Load Client Details
- Validates admin is authenticated
- Finds user: User.findById(req.params.id)
- Finds user's links: Link.find({ userId: user._id })
- If user not found → Returns 404

STEP 2: Display Client Information
- User details:
  * Name, Email, Phone Number
  * Business Name, Address
  * UPI ID, Payee Name, App ID (aid)
  * Subscription status
  * Account activation status
- Links list:
  * All links with titles, URLs, categories
  * Active/inactive status

STEP 3: Admin Actions
- "Activate Account" button:
  * Sets user.accountActivated = true
  * Saves user
  * Client can now generate QR code
- "Deactivate Account" button:
  * Sets user.accountActivated = false
  * Saves user
- "Delete Client" button:
  * Deletes user and all links
  * Removes from database

STEP 4: Render Client Details Page
- Renders views/admin-client-detail.ejs
- Displays all client information
- Shows action buttons

================================================================================
5. PAYMENT SYSTEM - CURRENT PROCESS
================================================================================

A. SUBSCRIPTION PAYMENT (Client → Our Company)
-----------------------------------------------
Route: POST /payment/pay or POST /payment/create-order
File: routes/payment.js

PURPOSE: Client pays ₹999/year subscription to us

CURRENT IMPLEMENTATION:
- Simplified payment (for testing)
- Marks payment as completed without actual payment gateway
- Sets subscriptionActive = true
- Sets subscriptionEndDate = 1 year from now
- Saves payment record

FUTURE IMPLEMENTATION (Razorpay):
- Create Razorpay order
- Client pays via Razorpay checkout
- Verify payment signature
- Activate subscription

B. CLIENT PAYMENT (Client's Customer → Client)
-----------------------------------------------
Route: GET /p/:slug/pay
File: routes/public.js

PURPOSE: Client's customers pay the client directly

CURRENT IMPLEMENTATION:
- Uses direct UPI links (like shop QR codes)
- Generates: upi://pay?pa=CLIENT_UPI_ID&pn=CLIENT_NAME&aid=CLIENT_AID&cu=INR
- Opens UPI app directly when customer clicks "Pay Now" button

FLOW:
1. Customer clicks "Pay Now" button on public page
2. Server generates UPI link:
   * Extracts UPI ID from user.upiId
   * Extracts payee name from user.upiPayeeName or user.businessName
   * Includes 'aid' parameter if user.upiAid exists
3. Returns HTML page with JavaScript
4. JavaScript opens UPI app: window.location.href = upiUrl
5. Customer enters amount in UPI app
6. Customer pays directly to client's UPI ID

================================================================================
6. PAYMENT ISSUES - DETAILED PROBLEM ANALYSIS
================================================================================

A. THE MAIN PROBLEM
-------------------
CRITICAL ISSUE: Even ₹1 payments are failing with "payment limit exceeded" error

B. ROOT CAUSE ANALYSIS
-----------------------

ISSUE 1: Missing 'aid' Parameter (App ID)
------------------------------------------
PROBLEM:
- UPI links without 'aid' parameter are treated as P2P (Person-to-Person) payments
- P2P payments have restrictions:
  * ₹2000 transaction limit
  * Payment failures even for small amounts (₹1)
  * Bank-specific restrictions

CURRENT BEHAVIOR:
- If client doesn't have 'aid' parameter:
  * Generated link: upi://pay?pa=client@bank&pn=ClientName&cu=INR
  * Treated as P2P payment
  * Has ₹2000 limit
  * Payments fail even for ₹1

EXPECTED BEHAVIOR:
- With 'aid' parameter:
  * Generated link: upi://pay?pa=client@bank&pn=ClientName&aid=APP_ID&cu=INR
  * Treated as merchant payment (P2M)
  * No limits
  * Works for any amount

ISSUE 2: Client Doesn't Have 'aid' Parameter
----------------------------------------------
PROBLEM:
- Most clients don't have 'aid' parameter
- 'aid' requires merchant registration with bank or payment gateway
- Without 'aid', all payments are treated as P2P

CURRENT STATUS:
- System supports 'aid' parameter
- Client can enter 'aid' in dashboard
- But most clients don't have it
- Without it, payments fail

ISSUE 3: Direct UPI Links Without Merchant Registration
--------------------------------------------------------
PROBLEM:
- We're generating direct UPI links without proper merchant registration
- This is why payments are treated as P2P
- Shop QR codes work because shops have merchant accounts with banks

CURRENT APPROACH:
- Direct UPI links: upi://pay?pa=UPI_ID&pn=NAME&cu=INR
- No merchant registration
- Treated as P2P → Has limits → Fails

SHOP APPROACH:
- Merchant UPI QR codes from bank
- Contains merchant credentials
- Treated as P2M → No limits → Works

C. SPECIFIC ERROR SCENARIOS
---------------------------

SCENARIO 1: Payment Without 'aid'
---------------------------------
Client UPI ID: nad.nandagiri-3@okicici
Generated Link: upi://pay?pa=nad.nandagiri-3@okicici&pn=ClientName&cu=INR
Result: "Payment limit exceeded" error even for ₹1
Reason: Treated as P2P payment, has restrictions

SCENARIO 2: Payment With 'aid'
-------------------------------
Client UPI ID: abhirammachamalla1289@oksbi
Client 'aid': uGICAgID13IaAGA
Generated Link: upi://pay?pa=abhirammachamalla1289@oksbi&pn=Abhiram%20Machamalla&aid=uGICAgID13IaAGA&cu=INR
Result: Should work without limits
Reason: Treated as merchant payment (P2M)

SCENARIO 3: Payment With Invalid 'aid'
---------------------------------------
Client UPI ID: client@bank
Client 'aid': INVALID_AID
Generated Link: upi://pay?pa=client@bank&pn=Name&aid=INVALID_AID&cu=INR
Result: Payment fails
Reason: 'aid' doesn't match UPI ID or is invalid

D. TECHNICAL DETAILS
---------------------

UPI LINK PARAMETERS:
- pa: Payee Address (UPI ID) - REQUIRED
- pn: Payee Name - REQUIRED
- cu: Currency (default: INR) - OPTIONAL
- aid: App ID (for merchant payments) - OPTIONAL BUT CRITICAL
- am: Amount (pre-fills amount) - OPTIONAL
- tn: Transaction note - OPTIONAL
- tr: Transaction reference - OPTIONAL

P2P vs P2M:
- P2P (Person-to-Person): Without 'aid', personal payments, has limits
- P2M (Person-to-Merchant): With 'aid', merchant payments, no limits

CURRENT CODE LOCATION:
- File: routes/public.js
- Function: handleDirectUPIPayment()
- Line: ~225
- Generates: upi://pay?pa=...&pn=...&aid=...&cu=INR

================================================================================
7. WHAT NEEDS TO BE FIXED
================================================================================

A. IMMEDIATE FIXES NEEDED
-------------------------

FIX 1: Ensure 'aid' Parameter is Always Included
-------------------------------------------------
PROBLEM: If client doesn't have 'aid', payments fail
SOLUTION OPTIONS:
- Option A: Require 'aid' parameter for all clients (strict)
- Option B: Use default 'aid' from environment variable (fallback)
- Option C: Use Razorpay Payment Links if 'aid' not available (hybrid)

CURRENT STATUS: System supports 'aid' but doesn't require it
RECOMMENDATION: Implement Option C (hybrid approach)

FIX 2: Better Error Handling
-----------------------------
PROBLEM: Generic "payment limit exceeded" error doesn't help
SOLUTION:
- Detect if payment failed due to missing 'aid'
- Show specific error message: "Please add App ID (aid) in dashboard"
- Provide instructions on how to get 'aid'

FIX 3: Payment Link Validation
-------------------------------
PROBLEM: No validation of UPI ID or 'aid' before generating link
SOLUTION:
- Validate UPI ID format before generating link
- Check if 'aid' is valid (if provided)
- Show warnings in dashboard if 'aid' is missing

B. LONG-TERM SOLUTIONS
----------------------

SOLUTION 1: Razorpay Integration for Clients Without 'aid'
----------------------------------------------------------
APPROACH:
- If client has 'aid': Use direct UPI links (current approach)
- If client doesn't have 'aid': Use Razorpay Payment Links
- Razorpay handles merchant payments properly
- No 'aid' needed for Razorpay

BENEFITS:
- Works for all clients (with or without 'aid')
- No payment limits
- Professional payment experience
- Multiple payment methods

DRAWBACKS:
- Requires Razorpay account setup
- Payment gateway fees (2-3%)
- Goes through Razorpay page (not direct UPI)

SOLUTION 2: Help Clients Get 'aid' Parameter
---------------------------------------------
APPROACH:
- Provide clear instructions in dashboard
- Guide clients to register as merchants with banks
- Help them get 'aid' from bank or payment gateway
- Validate 'aid' once they enter it

BENEFITS:
- Direct UPI payment (like shops)
- No payment gateway fees
- Works with all UPI apps

DRAWBACKS:
- Requires client to register as merchant
- Takes time to get 'aid'
- Not all clients can get 'aid'

SOLUTION 3: Hybrid Approach (RECOMMENDED)
------------------------------------------
APPROACH:
- Primary: Direct UPI links with 'aid' (if client has it)
- Fallback: Razorpay Payment Links (if client doesn't have 'aid')
- Best of both worlds

IMPLEMENTATION:
1. Check if client has 'aid' parameter
2. If yes: Generate direct UPI link (current approach)
3. If no: Generate Razorpay Payment Link
4. Show appropriate message in dashboard

BENEFITS:
- Works for all clients
- Direct payment when possible
- Fallback when needed
- No payment limits

C. SPECIFIC CODE CHANGES NEEDED
-------------------------------

CHANGE 1: routes/public.js - handleDirectUPIPayment()
------------------------------------------------------
CURRENT:
- Generates UPI link with or without 'aid'
- If no 'aid', link still generated (causes P2P issues)

NEEDED:
- Check if 'aid' exists
- If no 'aid': Use Razorpay Payment Links instead
- If 'aid' exists: Use direct UPI link (current)

CHANGE 2: routes/dashboard.js - update-profile route
-----------------------------------------------------
CURRENT:
- Accepts 'aid' parameter
- Extracts 'aid' from UPI URL if pasted
- Saves 'aid' to database

NEEDED:
- Add validation for 'aid' format
- Show warning if 'aid' is missing
- Provide instructions on how to get 'aid'

CHANGE 3: views/dashboard.ejs - UPI ID input
---------------------------------------------
CURRENT:
- Shows status indicator (green if 'aid' exists, orange if not)
- Provides instructions on how to get 'aid'

NEEDED:
- Add link to Razorpay registration (if 'aid' not available)
- Show example of working UPI link with 'aid'
- Add test payment button to verify 'aid' works

D. TESTING NEEDED
------------------

TEST 1: Payment Without 'aid'
------------------------------
- Create test client without 'aid'
- Try to pay ₹1
- Expected: Should use Razorpay Payment Links (if implemented)
- Current: Fails with "payment limit exceeded"

TEST 2: Payment With 'aid'
--------------------------
- Create test client with valid 'aid'
- Try to pay ₹1, ₹100, ₹1000, ₹10000
- Expected: All should work
- Current: Should work if 'aid' is valid

TEST 3: Payment With Invalid 'aid'
-----------------------------------
- Create test client with invalid 'aid'
- Try to pay ₹1
- Expected: Should show specific error
- Current: Generic error

================================================================================
SUMMARY
================================================================================

CURRENT STATUS:
- All flows (signup, login, profile, QR generation, admin) are working
- Payment system has critical issue: Even ₹1 payments fail
- Root cause: Missing 'aid' parameter causes P2P treatment (has limits)

IMMEDIATE ACTION REQUIRED:
- Implement hybrid approach: Direct UPI with 'aid' OR Razorpay Payment Links
- Add better error handling and user guidance
- Validate 'aid' parameter before generating payment links

LONG-TERM GOAL:
- Help clients get 'aid' parameter from banks/payment gateways
- Support both direct UPI (with 'aid') and Razorpay Payment Links
- Ensure all payments work without limits

================================================================================
END OF DOCUMENT
================================================================================
